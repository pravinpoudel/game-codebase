"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var l=0;l<t.length;l++){var n=t[l];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,l){return t&&_defineProperties(e.prototype,t),l&&_defineProperties(e,l),e}var GamePlay=function(){function l(e,t){_classCallCheck(this,l),this.myKeyboard=t,this.myMouse=null,this.lastTimeStamp,this.manager=e,this.model=null,this.initialize=this.initialize.bind(this),this.run=this.run.bind(this),this.playerModel=null,self.wallModel=null,this.renderCircle=!1,this.sound=null,this.particlesSmoke=null,this.creeps=[],this.towers=[],this.registerKey=this.registerKey.bind(this),this.flyingScores=[],this.tower1=new Image,this.tower1.src="assets/turret/turret-5-3.png",this.render=this.render.bind(this),this.firstTime=!0,this.downHandler=this.downHandler.bind(this),this.enemyCreator=null,this.canPlace=!1,this.upgrade=this.upgrade.bind(this),this.sell=this.sell.bind(this),this.renderScore=this.renderScore.bind(this),this.startNewWave=this.startNewWave.bind(this),this.level=0,this.towerType=["Gun","Missile","Air","Mix (Air + Ground)"],this.gameOverText="Game Over"}return _createClass(l,[{key:"upgrade",value:function(e){var t=Math.floor(.5*towerClicked.specs.cost);if(console.log(towerClicked),t<=money&&towerClicked)if(null==towerClicked.totalElapsedTime)towerClicked.totalElapsedTime=0;else if(towerClicked.totalElapsedTime+=e,200<=towerClicked.totalElapsedTime)if(console.log("upgraded"),towerClicked.totalElapsedTime-=200,towerClicked.upgradeCount){if(3<=towerClicked.upgradeCount)return;towerClicked.upgradeCount=towerClicked.upgradeCount+1,towerClicked.delay=Math.floor(.7*towerClicked.delay),towerClicked.specs.power=towerClicked.specs.power+1,money-=t,gameSound.playSound("add")}else towerClicked.upgradeCount=1}},{key:"sell",value:function(){if(towerClicked)for(var e=this.towers.length,t=0;t<e;t++)if(isColliding2(this.towers[t].specs.center.x-cellWidth/2,this.towers[t].specs.center.y-cellWidth/2,cellWidth,towerClicked.specs.center.x-cellWidth/2,towerClicked.specs.center.y-cellWidth/2,cellWidth))return money+=Math.floor(.7*towerClicked.specs.cost),towerSold(this.towers[t].specs.center.x-cellWidth/2,this.towers[t].specs.center.y-cellWidth/2),this.towers.splice(t,1),gameSound.playSound("die"),void(towerClicked=null)}},{key:"createElement",value:function(){selectedTower=this.getAttribute("data-myName"),towerRadius=this.getAttribute("data-radius"),moneyRequired=parseInt(this.getAttribute("data-cost")),towerTypeSelected=parseInt(this.getAttribute("data-type")),moneyRequired<=money&&(renderCircle=!0,mouse.isActive=!0)}},{key:"downHandler",value:function(e){if(mouse.isActive){firstTime=!0,mouse.isActive=!1,renderCircle=!1,canCreated(this.towers)&&this.canPlace&&(this.towers.push(createTower(GameState.assets[selectedTower],Math.floor(mouse.x/cellWidth)*cellWidth,Math.floor((mouse.y-200)/cellWidth)*cellWidth+200,2500,1,towerRadius,moneyRequired,towerTypeSelected)),money-=moneyRequired,moneyRequired=0,towerTypeSelected=0,gameSound.playSound("add"));canvas.getBoundingClientRect()}else{var t=canvas.getBoundingClientRect();mouse.x=e.clientX-t.left,mouse.y=e.clientY-t.top,findSelectedTower(this.towers)}}},{key:"muteVolume",value:function(e){e.preventDefault();for(var t=document.getElementsByClassName("volumeButton"),l=0;l<t.length;l++)t[l].style.display="block";var n=this.getAttribute("data-myId");document.getElementById(n).style.display="none","muteButton"==n&&gameSound.stopAllSound(),"unmuteButton"==n&&gameSound.unMuteSound()}},{key:"startNewWave",value:function(e){e&&e.preventDefault(),console.log("start button clicked"),this.enemyCreator=levels[this.level].sendNextWave(),startButton.style.display="none",nextWave=!1,GameState.cancelNextRequest=!1}},{key:"checkCanProceed",value:function(){2<this.level&&(this.gameOverText="You Won !!!",GameState.cancelNextRequest=!0,add(score)),GameState.life<=0&&(GameState.cancelNextRequest=!0,add(score))}},{key:"initialize",value:function(){var e=this;createLevels(),makeParticle2(),this.myMouse=new Mouse,GameState.cancelNextRequest=!1,GameState.life=10,e.myKeyboard.register("Escape",function(){GameState.cancelNextRequest=!0,e.manager.showScreen("mainmenu")});for(var t=0;t<rows;t++){for(var l=[],n=0;n<cols;n++)l.push({x:t,y:n});cellSet.push(l)}towerElements=document.getElementsByClassName("tower");for(var r=0;r<towerElements.length;r++)towerElements[r].addEventListener("click",this.createElement,!1);towerElements2=document.getElementsByClassName("volumeButton");for(r=0;r<towerElements2.length;r++)towerElements2[r].addEventListener("click",this.muteVolume,!1);startButton=document.getElementById("startButton"),startButton.addEventListener("click",this.startNewWave),this.bulletController=new BulletController(this.creeps),this.myMouse.register("mousedown",this.downHandler),this.myMouse.register("mousemove",function(e,t){if(mouse.isActive){var l=canvas.getBoundingClientRect();mouse.x=e.clientX-l.left,mouse.y=e.clientY-l.top,mouse.y<200&&(mouse.y=200),this.renderCircle=!0}})}},{key:"processInput",value:function(e){this.myKeyboard.update(e),this.myMouse.update(e)}},{key:"registerKey",value:function(){var t=this,e=localStorage.upgrade,l=localStorage.sell,n=localStorage.start;t.myKeyboard.register(e,function(e){t.upgrade(e)}),t.myKeyboard.register(l,function(e){t.sell(e)}),t.myKeyboard.register(n,function(e){t.startNewWave(e)})}},{key:"update",value:function(e){if(GameState.life<=0)GameState.cancelNextRequest=!0;else{particleSystem1.update(e),particleSystem2.update(e);for(var t=this.creeps.length,l=0;l<t;l++){var n=this.creeps[l];if(n){if(n.player.reachRight()||n.player.reachBottom()){this.creeps.splice(l,1),GameState.life--;continue}if(0==n.health){var r=n.player.specs.center.x,s=n.player.specs.center.y;score+=n.maxHealth,this.creeps.splice(l,1),creepDied(r,s),totalCreepKilled++,money+=n.maxHealth,gameSound.playSound("die");var o=new MovingEvents({size:{x:50,y:50},center:{x:r,y:s},rotation:0,moveRate:.125,rotateRate:Math.PI/1e3,continousSpeed:50,yDirection:-1,xDirection:0});this.flyingScores.push(new FlyingScore(n.maxHealth,o,!0));continue}n.update(e);for(var i=this.towers.length,a=0;a<i;a++){var c=this.towers[a];if((void 0!==n.flying||3!=c.specs.type)&&!(void 0!==n.flying&&c.specs.type<3)&&isColliding(n,c,c.specs.radius)&&(c.setTarget(n.player.specs.center.x,n.player.specs.center.y),c.canShoot)){c.isFirst=!1;var d={x:c.specs.target.x-c.specs.center.x,y:c.specs.target.y-c.specs.center.y};d=normalize(d);var u=c.specs.center.x,h=c.specs.center.y;this.bulletController.addBullet(u,h,n,c.specs.power,c.specs.type),gameSound.playSound("shoot")}c.update(e)}}}this.bulletController.update(e);for(var m=this.flyingScores.length,y=0;y<m;y++)this.flyingScores[y].update(e),this.flyingScores[y].isVisible||(this.flyingScores.splice(y,1),y--,m--);if(this.enemyCreator){var p=this.enemyCreator.createEnemy(e);p&&this.creeps.push(p)}}}},{key:"renderScore",value:function(){if(document.getElementById("currentScore").innerHTML=score,document.getElementById("lives").innerHTML=GameState.life,document.getElementById("money").innerHTML=money,this.level<3){var e=levels[this.level].wave+1+"/"+maxWave;document.getElementById("wave").innerHTML=e}document.getElementById("startButton");document.getElementById("level").innerHTML=this.level+1,document.getElementById("killed").innerHTML=totalCreepKilled;var t=0;this.towers.forEach(function(e){t+=e.specs.cost}),document.getElementById("towerValue").innerHTML=t,0<moneyRequired?(document.getElementById("selectedInfo").style.display="block",document.getElementById("moneyRequired").innerHTML=moneyRequired,document.getElementById("power").innerHTML=this.towerType[parseInt(towerTypeSelected)-1]):(document.getElementById("selectedInfo").style.display="none",document.getElementById("moneyRequired").innerHTML="",document.getElementById("power").innerHTML="")}},{key:"render",value:function(){var e=this;if(context.clearRect(0,0,canvas.width,canvas.height),context.fillStyle="green",context.fillRect(0,200,600,800),context.clearRect(50,250,500,500),context.clearRect(0,400,50,200),context.clearRect(550,400,50,200),context.clearRect(175,200,225,50),context.clearRect(175,750,225,50),nextWave&&e.level<3&&("top"==levels[e.level].enemyCreators[levels[e.level].wave+1].position?(context.fillStyle="#d7a20e",context.fillRect(175,200,225,50)):"left"==levels[e.level].enemyCreators[levels[e.level].wave+1].position&&(context.fillStyle="#d7a20e",context.fillRect(0,400,50,200))),mouse.isActive){for(var t=!1,l=0;l<rows;l++)for(var n=0;n<cols;n++){var r=cellSet[l][n].x,s=cellSet[l][n].y;Math.floor((mouse.x-leftOffset)/cellWidth)==r&&Math.floor((mouse.y-topOffset)/cellWidth)==s&&(t=this.canPlace=!0,context.beginPath(),context.rect(r*cellWidth+leftOffset,s*cellWidth+topOffset,cellWidth,cellWidth),context.stroke())}t||(this.canPlace=!1)}context.beginPath(),context.moveTo(0,200),context.lineTo(canvas.width,200),context.stroke(),renderCircle&&drawTower(towerRadius),context.fillStyle="black",this.renderScore(),this.creeps.forEach(function(e){e.render()});for(var o=this.towers.length,i=0;i<o;i++){this.towers[i].render()}towerClicked&&drawRectangle({x:towerClicked.specs.center.x-cellWidth/2,y:towerClicked.specs.center.y-cellWidth/2,width:50,height:50,fill:"#ffd63f9e",stroke:"red"}),this.bulletController.render();for(var a=this.flyingScores.length,c=0;c<a;c++)this.flyingScores[c].render();particleSystem1.render(),particleSystem2.render()}},{key:"run",value:function(){var l=this;gameSound=new Sound,gameSound.loadAudio(),gameSound.playSound("game_play"),gameSound.changeVolume(10),this.registerKey();var n=performance.now();GameState.cancelNextRequest=!1,context.fillStyle="black",requestAnimationFrame(function e(t){l.enemyCreator&&l.enemyCreator.totalEnemy<=0&&0==l.creeps.length&&0<wave&&l.level<3&&!nextWave&&(nextWave=!0,levels[l.level].wave>=levels[l.level].enemyCreators.length-1?(l.level++,l.towers=[],startButton.style.display="block"):setTimeout(function(){l.startNewWave()},1e3)),l.checkCanProceed(),GameState.cancelNextRequest?(0<score&&add(score),gameSound.pauseSound("game_play"),gameSound.playSound("success_end"),gameSound.changeVolume(20),context.font="70px roboto",context.fillStyle="black",context.textAlign="center",context.fillText(l.gameOverText,canvas.width/2,.6*canvas.height),context.fillText(score,canvas.width/2,.8*canvas.height),setTimeout(function(){l.manager.showScreen("mainmenu")},4e3)):(requestAnimationFrame(e),l.processInput(t-n),l.update(t-n),n=t,l.render()),n=t})}}]),l}();
//# sourceMappingURL=game-play.min.js.map
